<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Hibernate Session (双语) &mdash; Zale - Zale's Blog 张乐博客 个人网站</title>

    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="alternate" type="application/atom+xml" title="overtrue" href="/atom.xml">

    <link rel="apple-touch-icon-precomposed" href="/assets/images/apple-touch-icon-57x57-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/images/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/images/apple-touch-icon-114x114-precomposed.png">
    
    <meta property="og:title" content="Hibernate Session (双语)">
      
    <meta name="keywords" content="Zale, 张乐, blog, 博客, ZhangLe, 个人网站">
    <meta name="og:keywords" content="Zale, 张乐, blog, 博客, ZhangLe, 个人网站">
      
    <meta name="description" content="Session interface is a single threaded object between Java application and the persistence layer. Session opens a single database connection when it is created, and holds onto it until the session is closed. It is mainly to offer CRUD operations on the persistent object which is loaded by Hibernate from the database.">
    <meta name="og:description" content="Session interface is a single threaded object between Java application and the persistence layer. Session opens a single database connection when it is created, and holds onto it until the session is closed. It is mainly to offer CRUD operations on the persistent object which is loaded by Hibernate from the database.">
      
    
    
        
    
    <meta property="og:url" content="//articles/2016/02/Hibernate-Session.html">
    <meta property="og:site_name" content="zale.site">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2016-02-13">
    

    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <!-- 3rd party css -->


    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/Trip.js/dist/trip.min.css">
    <link rel="stylesheet" href="/bower_components/flag-icon-css/css/flag-icon.css" >
    <link rel="stylesheet" href="/bower_components/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="/bower_components/primer-css/css/primer.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">

    <!-- custom css-->
    <link rel="stylesheet" href="/assets/css/components/collection.css">
    <link rel="stylesheet" href="/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="/assets/css/globals/common.css">
    <link rel="stylesheet" href="/assets/css/posts/index.css">
    <link rel="stylesheet" href="/assets/css/pages/index.css">
    <link rel="stylesheet" href="/assets/css/pages/hover-min.css">
    <link rel="stylesheet" href="/assets/css/globals/prism.css">
    <link rel="stylesheet" href="/assets/css/globals/responsive.css">


    <!-- 3rd party scripts -->
    <script src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script src="/bower_components/jquery-ui/jquery-ui.min.js"></script>
    <script src="/bower_components/Trip.js/dist/trip.min.js"></script>
    <script src="/bower_components/share.js/dist/js/share.min.js"></script>

    <!-- custom scripts-->
    <script src="/assets/js/index.js"></script>
    <script src="/assets/js/geopattern.js"></script>
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/lunr.min.js"></script>
    <script src="/assets/js/search.js"></script>


    

</head>
<body class="">
    <header class="site-header" id="site-header-id">
        <div class="container">
            <h1><a href="/" title="Zale"><span class="octicon octicon-mark-github"></span> Zale</a></h1>
            <nav class="site-header-nav" role="navigation">
                
                <a href="/" class=" site-header-nav-item hvr-underline-from-center" target="" title="Home">Home</a>
                
                <a href="/categories" class=" site-header-nav-item hvr-underline-from-center" target="" title="Categories">Categories</a>
                
                <a href="/wiki" class=" site-header-nav-item hvr-underline-from-center" target="" title="Wiki">Wiki</a>
                
                <a href="/bookmark" class=" site-header-nav-item hvr-underline-from-center" target="" title="Bookmark">Bookmark</a>
                
                <a href="/open-source" class=" site-header-nav-item hvr-underline-from-center" target="" title="Open-source">Open-source</a>
                
                <a href="/about" class=" site-header-nav-item hvr-underline-from-center" target="" title="About">About</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->
    <section class="collection-head collection-head-scrolled geopattern" data-pattern-id="Hibernate Sessi">
    <div class="container">
        <div class="columns">
            <div class="column">
                <div class="collection-title">
                    <h1 class="collection-header">Hibernate Session (双语)</h1>
                    <div class="collection-info">
                        <span class="meta-info">
                            
                            
                                <span class="octicon octicon-calendar"></span> 2016/02/13
                            
                        </span>
                        
                          <span class="meta-info">
                            <span class="octicon octicon-file-directory"></span>
                            <a href="/categories#hibernate" title="Hibernate">Hibernate</a>
                          </span>
                        
                        
                        <span class="meta-info">
                            <span class="octicon octicon-tag"></span>
                            
                            <a href="/tags#hibernate" title="Hibernate">Hibernate</a>
                            
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- / .banner -->
<section class="container content">
    <div class="columns">
        <div class="column three-fourths" >
            <article class="article-content markdown-body">
                <p>Session interface is a <strong>single threaded</strong> object between Java application and the persistence layer. Session opens a single database connection when it is created, and holds onto it until the session is closed. It is mainly to <strong>offer CRUD operations on the persistent object</strong> which is loaded by Hibernate from the database.</p>

<p>Session 就是一个在 Java 应用层和持久化层的<strong>单线程的</strong>对象。Session 在创建的时候就会打开一个数据库连接，并一直持有这个连接，直到Session被关闭。它主要用来为持久化对象上提供 CRUD 操作，而这些对象是由 Hibernate 从数据库中加载的。</p>

<p>More details, in Hibernate, Session interface wraps a JDBC connection, holds a mandatory (first-level) cache of persistent objects, allows Hibernate to automatically persist objects that are modified, and allows Hibernate to implement functionality such as lazy-loading.</p>

<p>详细点说，在 Hibernate 中，Session 其实是包装了 JDBC 连接，它持有持久化对象的强制缓存（一级缓存），这样就允许 Hibernate在对象被修改的时候自动的持久化对象，并让Hibernate 可以实现一些如懒加载之类的功能。</p>

<h2 id="state-of-persistent-object">State of persistent object</h2>

<p>Persistent objects should be in one of the following three states at a given point in time:</p>

<p>在任意时间，持久化对象只会是以下状态之一：</p>

<ul>
  <li>
    <p><strong>transient</strong>: A new instance of a persistent class which is not associated with a Session and has no representation in the database and no identifier value. (ex. <code class="highlighter-rouge">Person p = new Person</code>). You can make a transient instance persistent by associating it with a Session.</p>

    <p><strong>瞬时态</strong>：一个新的持久化类的实例对象，这个对象没有与任何的 Session 关联，没有表示数据库中的任何数据，没有唯一标识符（id）（如 <code class="highlighter-rouge">Person p = new Person</code>）。你可以让一个瞬时态对象与一个 Session 关联，让其成为持久态。</p>
  </li>
  <li>
    <p><strong>persistent</strong>: A persistent instance has a representation in the database, an identifier value and is associated with a Session.</p>

    <p><strong>持久态</strong>：一个持久化对象在数据库中有相应的表示，有唯一标识符（id），和一个 Session 关联。</p>
  </li>
  <li>
    <p><strong>detached</strong>: Once we close the Hibernate Session, the persistent instance will become a detached instance. But the reference of the object is still valid. You could continue to modify the object. These changes will not lost and will be inserted into database when associated with a Session which changes it back to persistent state.</p>

    <p><strong>游离态</strong>：一旦我们关闭 Hibernate Session，持久化对象将会变为游离态。但是对象的引用还是有效的，你可以继续修改对象。这些修改并不会丢失，当游离态对象与一个 Session 关联后将会变为持久态，而这些修改将会被插入数据库中。</p>
  </li>
</ul>

<h2 id="open-a-session">Open a Session</h2>

<blockquote>
  <p>Different version of Hibernate has different way to do it. The following is for Hibernate more than 3.x only.</p>
</blockquote>

<blockquote>
  <p>不同版本的 Hibernate 有不同的方法，以下的方法只适用于 Hibernate 3.x 以上版本。</p>
</blockquote>

<p>To open a Session, it’s better to create an util class:</p>

<p>最好创建一个工具类来打开一个 Session：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HibernateUtils</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">SessionFactory</span> <span class="n">sessionFactory</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">Configuration</span> <span class="n">cfg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Configuration</span><span class="o">().</span><span class="na">configure</span><span class="o">();</span>
        <span class="n">sessionFactory</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="na">buildSessionFactory</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Session</span> <span class="n">getSession</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>To use <code class="highlighter-rouge">getCurrentSession()</code>, it needs to add in <code class="highlighter-rouge">hibernate.cfg.xml</code>:</p>

<p>为了可以使用<code class="highlighter-rouge">getCurrentSession()</code>，你需要在<code class="highlighter-rouge">hibernate.cfg.xml</code>中配置：</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernate.current_session_context_class"</span><span class="nt">&gt;</span>thread<span class="nt">&lt;/property&gt;</span>
</code></pre>
</div>

<h3 id="opensession-vs-getcurrentsession">openSession vs getCurrentSession</h3>

<h4 id="opensession">openSession()</h4>

<ol>
  <li>
    <p>We can use it when we decided to manage the Session our self.</p>

    <p>我们打算自己管理 Session 的时候，可以使用它。</p>
  </li>
  <li>
    <p>It does not try to store or pull the Session from the current context. Just a brand new one.</p>

    <p>它不会尝试存储或者从当前上下文中获取 Session。仅仅创建一个新的 Session。</p>
  </li>
  <li>
    <p><strong>If we use this method, we need to <code class="highlighter-rouge">flush()</code> and <code class="highlighter-rouge">close()</code> the Session. It does not flush and close automatically</strong>.</p>

    <p><strong>如果我们使用这个方法，我们需要使用 <code class="highlighter-rouge">flush()</code> 和 <code class="highlighter-rouge">close()</code> 来管理 Session。Hibernate 并不会为我们自动的刷新或者关闭 Session。</strong></p>
  </li>
</ol>

<h4 id="getcurrentsession">getCurrentSession()</h4>

<p>The “CurrentSession” refers to a Hibernate Session bound by Hibernate behind the scenes, to the transaction scope. It <strong>creates a brand new session</strong> if does not exist or <strong>uses an existing one</strong> if one already exists. It automatically configured with both auto-flush and auto-close attributes as true means <strong>Session will be automatically flushed and closed</strong>. It’s better to use <code class="highlighter-rouge">getCurrentSession()</code> method when our transaction runs long time or with multi calls of Session.</p>

<p>“CurrentSession” 是 Hibernate 后台根据场景自动绑定到事务域的 Session。如果当前没有可用 Session，<strong>将会自动创建</strong>。如果有的话，<strong>将会使用现有的</strong>。他可以做到真正意义上的** Session 自动刷新和关闭**。当我们的事务需要执行很长时间的时候或者需要调用很多次 Session 的时候，最好使用 <code class="highlighter-rouge">getCurrentSession()</code>。</p>

<h2 id="save">save()</h2>

<p><code class="highlighter-rouge">save()</code> results in an SQL <code class="highlighter-rouge">INSERT</code>. It persists the given transient instance, first assigning a generated identifier. In brief, it adds/saves a new entity into database.</p>

<p><code class="highlighter-rouge">save()</code> 会导致一个 SQL <code class="highlighter-rouge">INSERT</code> 语句的执行。它会持久化一个瞬时态对象。它会生成一个唯一标识符（id）。总的来说，它会向数据库中增加/存储一个新实体。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">HibernateUtils</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
<span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span> 

<span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"Zale"</span><span class="o">);</span> 
<span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>

<span class="n">session</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="c1">// Because getCurrentSession(), so no need session.close();</span>
</code></pre>
</div>

<p>But be careful here, <code class="highlighter-rouge">save()</code> does not guarantee the same, it returns an identifier, and if an <code class="highlighter-rouge">INSERT</code> has to be executed to get the identifier, <strong>this <code class="highlighter-rouge">INSERT</code> happens immediately</strong>, no matter if you are inside or outside of a transaction. This is not good in a long-running conversation with an extended Session/persistence context.</p>

<p>但是这里需要小心，<code class="highlighter-rouge">save()</code>并不保证事务，它将返回持久化后的对象的统一标识符（id），如果一个<code class="highlighter-rouge">INSERT</code> 语句需要被执行来获得统一标识符（id），不管是否在事务内，<strong>这个<code class="highlighter-rouge">INSERT</code>将会立即执行</strong>。当我们需要继承 Session/persistence context 来实现长会话流程的时候，这样是不好的。</p>

<h2 id="persist">persist()</h2>

<p><code class="highlighter-rouge">persist()</code> also makes a transient instance persistent. However, it doesn’t guarantee that the identifier value will be assigned to the persistent instance immediately, the assignment might happen at flush time. It also guarantees that it will not execute an <code class="highlighter-rouge">INSERT</code> statement if it is called outside of transaction boundaries. This is useful in long-running conversations with an extended Session/persistence context.</p>

<p><code class="highlighter-rouge">persist()</code>同样可以让你一个瞬时态的对象变为持久态。但是它并不保证统一标识符（id）的值会立即赋值给持久化对象，这个赋值可能会被延迟到 Session flush 的时候。它保证当他在一个事务外被调用的时候不会触发<code class="highlighter-rouge">INSERT</code>语句。当我们需要继承 Session/persistence context 来实现长会话流程的时候，这样做是很有用的。</p>

<h2 id="load-and-get">load() and get()</h2>

<p><code class="highlighter-rouge">load()</code> and <code class="highlighter-rouge">get()</code> result in an SQL <code class="highlighter-rouge">SELECT BY ID</code>. It returns the persistent instance of the given entity class with the given identifier.(<code class="highlighter-rouge">load()</code> returna a “proxy”)</p>

<p><code class="highlighter-rouge">load()</code> 和 <code class="highlighter-rouge">get()</code> 都会导致 SQL <code class="highlighter-rouge">SELECT BY ID</code> 语句的执行。他们都会根据给定的统一标识符（id）返回实体类的持久化对象（<code class="highlighter-rouge">load()</code> 返回的是一个”代理”）</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">HibernateUtils</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
<span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">// 1 is the identifier in the database</span>
<span class="c1">// User user = (User) session.get(User.class, 1); </span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="c1">// Because we use getCurrentSession, so no need to run session.close();</span>
</code></pre>
</div>

<h3 id="difference-between-load-and-get">Difference between load() and get()</h3>

<ul>
  <li>
    <p><code class="highlighter-rouge">load()</code> returns a <strong>“proxy” without hitting the database</strong> (lazy loading). In Hibernate, “proxy” is an object with the given identifier value, its properties are not initialized yet, it just look like a temporary fake object. If no row found , it will <strong>throws an exception</strong> - ObjectNotFoundException.</p>

    <p><code class="highlighter-rouge">load()</code> 返回一个<strong>“代理”而不会命中数据库</strong>（也就是懒加载）。在 Hibernate 中，代理是一个有给定的统一标识符（id）对象，他的其他字段并没有被初始化，他看起来就像是一个零时的空壳对象。如果没有找到对应行，它将<strong>抛出一个异常</strong> - ObjectNotFoundException</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">get()</code> always <strong>hits the database and returns the real object</strong> instead of a proxy. If no row found , <strong>it return <code class="highlighter-rouge">null</code></strong>.</p>

    <p><code class="highlighter-rouge">get()</code>总是<strong>命中数据库和返回真实的对象</strong>而不是一个代理。如果没有找到对应行，<strong>它将返回 <code class="highlighter-rouge">null</code></strong></p>
  </li>
</ul>

<h3 id="which-one-to-use">Which one to use</h3>

<p>If I’m not sure whether the object exists or not, I use <code class="highlighter-rouge">get()</code> to avoid an exception. If I’m sure, I prefer <code class="highlighter-rouge">load()</code>.</p>

<p>如果我们不能确保对象是否存在，应该使用 <code class="highlighter-rouge">get()</code> 来避免异常，如果确保对象存在，建议使用 <code class="highlighter-rouge">load()</code> 来改善性能。</p>

<h2 id="update-and-saveorupdate">update() and saveOrUpdate()</h2>

<p>Which function will result in SQL <code class="highlighter-rouge">UPDATE</code>? We could find <code class="highlighter-rouge">update()</code> or <code class="highlighter-rouge">saveOrUpdate()</code>. But we need to know firstly, there is no need to call these functions to do update. When we <code class="highlighter-rouge">get()/load()</code> a persistent object, and then call setters to modify something. After transaction <code class="highlighter-rouge">commit()</code> or Session <code class="highlighter-rouge">flush()</code>. Database will be updated.</p>

<p>哪一个函数会导致 SQL <code class="highlighter-rouge">UPDATA</code>？我们翻阅官方 API 可以看到 <code class="highlighter-rouge">updata()</code> 或者 <code class="highlighter-rouge">saveOrUpdate()</code>。但是我们首先需要知道，我们并不是需要调用这些函数来实现更新数据库。当我们使用 <code class="highlighter-rouge">get()/load()</code> 获得的持久化对象，然后使用 setters 修改属性，当事务 <code class="highlighter-rouge">commit()</code> 或者 Session <code class="highlighter-rouge">funsh()</code>，数据库也会更新。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">HibernateUtils</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
<span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">30</span><span class="o">);</span>

<span class="n">session</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
<span class="c1">// or tx.commit(); it does the same thing</span>
<span class="c1">// Because getCurrentSession(), so no need session.close();</span>
</code></pre>
</div>

<h3 id="update">update()</h3>

<p>So why we need <code class="highlighter-rouge">update()</code>? In fact, it’s mainly used to updated a detached object which was ever a persistent object and now session is closed. When <code class="highlighter-rouge">update()</code> a detached object, <strong>it will become persistent again</strong>.</p>

<p>那我们为什么需要 <code class="highlighter-rouge">updata()</code>？实际上，这主要是为了更新游离态对象。还记得什么样的对象是游离态对象吗？游离态对象曾经是一个持久态对象，但是现在它对应的 Session 关闭了。当对游离态对象使用 <code class="highlighter-rouge">update</code>，<strong>它将会再次变为持久态</strong>。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">HibernateUtils</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
<span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="c1">// Because getCurrentSession(), so first session is closed here</span>

<span class="o">....</span>

<span class="c1">// Now user is in detached state. And we update it!</span>
<span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="mi">27</span><span class="o">));</span>

<span class="c1">// We open a second session</span>
<span class="n">Session</span> <span class="n">secondSession</span> <span class="o">=</span> <span class="n">HibernateUtils</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
<span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

<span class="c1">// Update!</span>
<span class="n">secondSession</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

<span class="c1">// Commit!</span>
<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="c1">// Because getCurrentSession(), so no need secondSession.close();</span>
</code></pre>
</div>

<h3 id="saveorupdate">saveOrUpdate()</h3>

<p>It means either <code class="highlighter-rouge">save()</code> or <code class="highlighter-rouge">update()</code> the given instance on the basis of identifier exists or not. When we are not sure whether the instance was ever persistent (so whether an identifier exists or not). USE IT! If the instance has an identifier, <code class="highlighter-rouge">update()</code> will be run to update it in databas. If no identifier, <code class="highlighter-rouge">save()</code> will be run to add an identifier and insert it into database.</p>

<p>正如函数名一样，具体是 <code class="highlighter-rouge">save()</code> 还是 <code class="highlighter-rouge">update()</code> 取决于对象的统一标识符（id）是否存在。当我们不确定实例是否曾经持久化（也就是不确定统一标识符是否存在），使用它就没错了！如果实例有标识符 <code class="highlighter-rouge">updata()</code> 将会被调用来更新数据库。如果没有标识符，<code class="highlighter-rouge">save()</code> 将会被调用来插入到数据库并为对象添加统一标识符。</p>

<h2 id="merge">merge()</h2>

<p><code class="highlighter-rouge">merge()</code> is also used to update a detached object. It copies the state of the given object onto the persistent object with the same identifier.</p>

<p><code class="highlighter-rouge">merge()</code> 也是用来更新游离态对象，它会将给定对象状态复制到相同统一标识符（id）的持久化对象。</p>

<p>The difference with <code class="highlighter-rouge">update()</code> is that <code class="highlighter-rouge">update()</code> tries to reattach the instance, meaning that there is no other persistent object with the same identifier attached to the Session right now otherwise NonUniqueObjectException is thrown. <code class="highlighter-rouge">merge()</code>, however, just copies all values to a persistent instance in the Session (which will be loaded if it is not currently loaded). The input object is not changed. So <code class="highlighter-rouge">merge()</code> is more general than <code class="highlighter-rouge">update()</code>, but may use more resources.</p>

<p>它和 <code class="highlighter-rouge">update()</code> 不同之处是 <code class="highlighter-rouge">update()</code> 会尝试将对象持久化，这也就是说，如果 Session 当前没有与给定对象一样唯一标识符（id）的对象，如果有的话将会抛出  NonUniqueObjectException。而 <code class="highlighter-rouge">merge()</code>，仅仅将所有值复制到 Session 中的持久化对象中（如果没有则立即加载）。输入的对象并没有变化。所以来说它比 <code class="highlighter-rouge">update()</code> 用途更广泛，但是也会消耗更多的资源。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">HibernateUtils</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
<span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

<span class="n">User</span> <span class="n">user1</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span> 
<span class="c1">// Because getCurrentSession(), so no need session.close();</span>

<span class="o">....</span>
<span class="n">user1</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">30</span><span class="o">);</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">HibernateUtils</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span> 
<span class="n">tx</span><span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span> 

<span class="n">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span> <span class="c1">// Same id as user1</span>

<span class="n">session</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span> <span class="c1">// It throws NonUniqueObjectException because in the session, another persistent object with the same id already exists. user1 == user2 false</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="c1">// Because we use getCurrentSession, so no need session.close();</span>
</code></pre>
</div>

<p>So if in this situation, we should use <code class="highlighter-rouge">merge()</code>, it needs to merge user1 with user2:</p>

<p>所以在这种情况下，我们需要使用 <code class="highlighter-rouge">merge()</code>，我们需要合并 user1 和 user2</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
<span class="n">User</span> <span class="n">user3</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>

<span class="c1">// user3 == user2 true</span>
</code></pre>
</div>

<p>So here <code class="highlighter-rouge">merge()</code> returns the <strong>same reference</strong> of user2.</p>

<p>所以这里 <code class="highlighter-rouge">merge()</code> 返回<strong>和 user2 相同的引用</strong>。</p>

<h2 id="delete">delete()</h2>

<p><code class="highlighter-rouge">delete()</code> results in SQL <code class="highlighter-rouge">DELETE</code></p>

<p><code class="highlighter-rouge">delete()</code> 会导致 SQL <code class="highlighter-rouge">DELETE</code> 语句的执行</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">HibernateUtils</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
<span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

<span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="n">session</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="c1">// Because getCurrentSession(), so no need session.close();</span>
</code></pre>
</div>

<h2 id="find">find()</h2>

<p>No <code class="highlighter-rouge">find()</code> in current version! We must use <code class="highlighter-rouge">Query</code> or <code class="highlighter-rouge">Criteria</code> to achieve it.</p>

<p>在当前版本不再有 <code class="highlighter-rouge">find()</code>！ 我们需要使用 <code class="highlighter-rouge">Query</code> 或者 <code class="highlighter-rouge">Criteria</code> 来实现它。</p>

<h2 id="flush">flush()</h2>

<p><code class="highlighter-rouge">session.flush()</code> forces Hibernate to <strong>synchronize the in-memory state of the Session with the database</strong>.</p>

<p><code class="highlighter-rouge">session.flush()</code> 强制Hibernate<strong>将内存中的状态同步到数据库</strong>。</p>

<p>By default, Hibernate will flush changes automatically for you:</p>

<p>默认情况下，Hibernate 将会自动刷新：</p>

<ul>
  <li>
    <p>Before some query executions</p>

    <p>在一些查询之前</p>
  </li>
  <li>
    <p>When a transaction is committed</p>

    <p>当事务提交的时候</p>
  </li>
</ul>

<p>We could also set flush mode, by default is AUTO:</p>

<p>我们同样也可以设置刷新模式，默认情况是 AUTO：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// The Session is flushed before every query.</span>
<span class="n">session</span><span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="n">FlushMode</span><span class="o">.</span><span class="na">ALWAYS</span><span class="o">);</span>
<span class="c1">// The Session is sometimes flushed before query execution in order to ensure that queries never return stale state.</span>
<span class="n">session</span><span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="n">FlushMode</span><span class="o">.</span><span class="na">AUTO</span><span class="o">);</span>
<span class="c1">// The Session is flushed when Transaction.commit() is called. </span>
<span class="n">session</span><span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="n">FlushMode</span><span class="o">.</span><span class="na">COMMIT</span><span class="o">);</span>
<span class="c1">// The Session is only ever flushed when Session.flush() is explicitly called by the application.</span>
<span class="n">session</span><span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="n">FlushMode</span><span class="o">.</span><span class="na">MANUAL</span><span class="o">);</span>
</code></pre>
</div>

<p>Be careful, <strong><code class="highlighter-rouge">setFlushMode()</code> must be invoked before <code class="highlighter-rouge">session.beginTransaction()</code></strong>.</p>

<p>需要注意，<strong><code class="highlighter-rouge">setFlushMode()</code> 必须在 <code class="highlighter-rouge">session.beginTransaction()</code> 之前被调用</strong>。</p>

<h2 id="ref">Ref</h2>

<ul>
  <li><a href="http://www.tutorialspoint.com/hibernate/hibernate_sessions.htm">Tutorialspoint - Point</a></li>
  <li><a href="https://docs.jboss.org/hibernate/orm/3.2/api/org/hibernate/Session.html">Hibernate API</a></li>
  <li><a href="http://stackoverflow.com/questions/5862680/whats-the-advantage-of-persist-vs-save-in-hibernate">Stackoverflow save() vs persist()</a></li>
</ul>

            </article>
            
            <div class="share">
                <div class="share-component"></div>
            </div>
            
            
            <div class="comment">
                
  
      
          <div id="disqus_thread"></div>
          <script>
            var disqus_config = function () {
              this.page=this.page||{};
              this.page.url = document.location.href.replace(document.location.host,'zale.site');
              this.page.identifier = '/articles/2016/02/Hibernate-Session.html';
              this.page.title = 'Hibernate Session (双语)';
            };
            (function() { // DON'T EDIT BELOW THIS LINE
              var d = document, s = d.createElement('script');

              s.type = 'text/javascript';
              s.async = true;
              var shortname = 'zale';

              s.src = '//' + shortname + '.disqus.com/embed.js';

              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
            })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      
    

            </div>
            
        </div>
        <div class="column one-fourth">
            
<h3>Search</h3>
<form action="get" id="site_search">
    <input type="text" id="search_box" placeholder="Search">
    <button class="btn btn-default" type="submit"><span class="octicon octicon-search"></span></button>
</form>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="/assets/css/modules/sidebar-search.css">


            <h3>Directory</h3>
<div id="post-directory-module">
    <section class="post-directory">
        <!-- Links that trigger the jumping -->
        <!-- Added by javascript below -->
        <dl></dl>
    </section>
</div>

<script type="text/javascript">

    $(document).ready(function () {
        $("article h2").each(function (index) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" href=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3");

            children.each(function (index) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" href=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        //排除小设备下的fixed布局
        if ($(document).width() > parseFloat($('body').css('fontSize')) * 50) {

            var fixmeTop = $('#post-directory-module').offset().top - 80;       // get initial position of the element
            $(window).scroll(function () {                  // assign scroll event listener

                var currentScroll = $(window).scrollTop(); // get current position

                if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                    $('#post-directory-module').css({                      // scroll to that element or below it
                        top: '80px',
                        position: 'fixed',
                    });
                } else {                                   // apply position: static
                    $('#post-directory-module').css({                      // if you scroll above it
                        position: 'inherit',
                    });
                }
            });
        }
        $('#post-directory-module a').parent().click(function ($event) {
            $(this).find('a').click();
        });
    });


</script>
        </div>
    </div>
</section>
<!-- /section.content -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
  inlineMath: [['$','$'], ['\\(','\\)']]
  }
});
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    © 2015
                    <span title="Zale">Zale</span>
                    <a href="javascript:$('body, html').animate({scrollTop: 0}, 600)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:$('body, html').animate({scrollTop: 0}, 600)" >TOP</a>
                </li>
            </ul>
            <a href="https://github.com/zl810881283/zl810881283.github.io" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="/" title="Home" target="">Home</a>
                </li>
                
                <li>
                    <a href="/categories" title="Categories" target="">Categories</a>
                </li>
                
                <li>
                    <a href="/wiki" title="Wiki" target="">Wiki</a>
                </li>
                
                <li>
                    <a href="/bookmark" title="Bookmark" target="">Bookmark</a>
                </li>
                
                <li>
                    <a href="/open-source" title="Open-source" target="">Open-source</a>
                </li>
                
                <li>
                    <a href="/about" title="About" target="">About</a>
                </li>
                
                <li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>

        </div>
    </footer>
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-76860417-1', 'auto');
        ga('send', 'pageview');

    </script>

    
    <script src="/assets/js/hashchange.js"></script>
    </body>
</html>
